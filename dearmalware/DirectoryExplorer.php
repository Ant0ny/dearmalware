<?php

namespace DearMalware;

use DearMalware\TemplateEngine;

class DirectoryExplorer {

    public $view;

    public function __construct() {
        $this->view = new TemplateEngine();
    }

    /**
     * List directories included into initital one.
     *
     * @param void
     * @return string
     */
    public function listDirectories() {
        unset($_SESSION['files']);
        $dirs = $this->browseDirectories(CAT, EXTS);
        $result = $this->view->render('list_directories', ['dirs' => $dirs]);

        return $result;
    }

    /**
     * Browse included directories recursively.
     *
     * @param string $dir
     * @param array $exts
     * @return string
     */
    private function browseDirectories(string $dir = '', array $exts = []) {
        static $deep = 0;
        static $result;

        $odir = opendir($dir);

        while (($file = readdir($odir)) !== FALSE) {

            if ($file == '.' || $file == '..') {
                continue;
            } else {
                $flag = 0;

                foreach ($exts as $ext) {
                    if (mb_strpos($file, $ext)) {
                        $flag = 1;
                    }
                }

                $str = '';

                if ($flag) {
                    $str = '<span class="red"> ...verifying</span>';
                }

                $result .= str_repeat('---', $deep) . $dir . DIRECTORY_SEPARATOR . $file . $str . '<br>';

                $_SESSION['files'][] = $dir . DIRECTORY_SEPARATOR . $file;
            }

            if (is_dir($dir . DIRECTORY_SEPARATOR . $file)) {

                $deep++;
                $this->browseDirectories($dir . DIRECTORY_SEPARATOR . $file, $exts);
                $deep--;
            }
        }

        closedir($odir);

        return $result;
    }

}