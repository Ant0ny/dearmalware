<?php
@session_start();
$cat = __DIR__;

if ($_POST['action'] == 'get_structure'){
	unset($_SESSION['files']);
	echo '<h2>Структура директорий Вашего сайта:</h2><button class="btn" data-toggle="collapse" data-target="#collapseExample">Посмотреть структуру</button>'; 
	echo '<div class="collapse" id="collapseExample">'; recursive($cat); 
	echo '</div>';
}

if ($_POST['action'] == 'check_viruses'){
	$search_1 = array(
		'base64_decode','base64_encode','eval','system','system_shell','exec','passthru'
	);
	$search_2 = array(
		'$_POST', '$_GET', '$_REQUEST'
	);
	$exts = array(
		'.php','.inc','.phtml'
	);
	$output = '<h3>Проверяемый файл:</h3>'; 
	foreach ($_SESSION['files'] as $file){
		$count_1 = $count_2 = $results_1 = $results_2 = 0;
		$flag = 0;
		foreach($exts as $ext){
			if (mb_strpos($file, $ext)){
				$flag = 1;
			}
		}
		if ($flag){
			$output .= '<p>'.$file.'<br>';
			$str = file_get_contents($file);
			foreach ($search_1 as $s){
				$count_1 += mb_substr_count($str, $s);
			}	
			if ($count_1) //$results_1[$file] = $count_1;
				$output .= '<strong>'.getNumEnding($count_1, array('Найдена','Найдены','Найдены')).' <span class="red">'.$count_1.'</span> '.
					getNumEnding($count_1, array('опасная функция', 'опасных функций', 'опасных функций')).' </strong><!-- [?]--><br>';
			foreach ($search_2 as $s){
				$count_2 += mb_substr_count($str, $s);		
			}	
			if ($count_2) //$results_2[$file] = $count_2;
				$output .= '<strong>'.getNumEnding($count_1, array('Найдена','Найдены','Найдены')).' <span class="yellow">'.$count_2.
					'</span> потенциально '.getNumEnding($count_1, array('опасная переменная', 'опасных переменных', 'опасных переменных')).' HTTP-запроса</strong><!-- [?]--><br>';			
				
			$output .= '</p>';
			if ($count_1 || $count_2){
				$is_found = true;
			} else {
				$is_found = false;
			}
			//break;
		}
	}
	header('Content-type: application/json; charset=utf-8');
	echo json_encode(array('whatfound'=>$output,'isfound'=>$is_found));
	exit;
}

function getNumEnding($number, $endingArray)
{
    $number = $number % 100;
    if ($number>=11 && $number<=19) {
        $ending=$endingArray[2];
    }
    else {
        $i = $number % 10;
        switch ($i)
        {
            case (1): $ending = $endingArray[0]; break;
            case (2):
            case (3):
            case (4): $ending = $endingArray[1]; break;
            default: $ending=$endingArray[2];
        }
    }
    return $ending;
}

function recursive($dir)
{
   static $deep = 0;
 
   $odir = opendir($dir);
 
   while (($file = readdir($odir)) !== FALSE)
   {
      if ($file == '.' || $file == '..')
      {
         continue;
      }
      else
      {
         echo str_repeat('---', $deep).$dir.DIRECTORY_SEPARATOR.$file.'<br>';
		 $_SESSION['files'][] = $dir.DIRECTORY_SEPARATOR.$file;
      }
 
      if (is_dir($dir.DIRECTORY_SEPARATOR.$file))
      {
         $deep ++;
         recursive($dir.DIRECTORY_SEPARATOR.$file);
         $deep --;
      }
   }
   closedir($odir);
}
 
?>